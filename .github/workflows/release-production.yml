name: 'Stencil Production Release'
on:
  workflow_call:
    inputs:
      tag:
        required: false
        default: latest
        type: string
        description: Which npm tag should this be published to? (dev, latest, or use_pkg_json_version)
      base:
        required: true
        type: string
        description: Which base branch should be targeted? (main or v3-maintenance)
        default: main

permissions:
  contents: write
  id-token: write

jobs:
  release-stencil-production-build:
    name: Publish Stencil (Production)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      # Log the input from GitHub Actions for easy traceability
      - name: ğŸ”’ Log GitHub Workflow UI Input
        run: |
          echo "Tag: ${{ inputs.tag }}"
          echo "Base Branch: ${{ inputs.base }}"
        shell: bash

      - name: ğŸ” Verify that the 'latest' tag is applied only to the 'main' branch
        run: |
          echo "The 'latest' tag can only be published from the 'main' branch. Exiting."
          exit 1
        shell: bash
        if: ${{ inputs.base != 'main' && inputs.tag == 'latest' }}

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          # A depth of 0 gets the entire git history, which we'll want for things like checking all git history/tags.
          # We need git history to generate the changelog; however, we don't know how deep to go.
          # Since publishing is a one-off activity, just get everything.
          fetch-depth: 0
          ref: ${{ inputs.base }}

      - name: ğŸ•¸ï¸ Get Core Dependencies
        uses: ./.github/workflows/actions/get-core-dependencies

      - name: ğŸŸ¢ Configure Node for Publish
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ”„ Ensure Latest npm
        run: npm install -g npm@latest
        shell: bash

      - name: ğŸ“¦ Run Publish Scripts
        # pass the generated version number instead of the input, since we've already incremented it in the prerelease
        # step
        run: npm run release.ci -- --tag ${{ inputs.tag }}
        shell: bash
